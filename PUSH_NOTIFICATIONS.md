# Push-повідомлення та Історія Змін

Детальна документація для інтеграції push-повідомлень та відстеження історії змін графіків.

## 📊 Нові можливості

### 1. Історія змін
- Зберігання всіх версій графіків
- Метадані: час створення, оновлення, кількість змін
- Повна історія оновлень для кожної дати

### 2. Метадані графіків
- Дата першої публікації
- Час останнього оновлення
- Кількість оновлень
- ID повідомлення з Telegram

### 3. Готові повідомлення для Push
- Автоматична генерація текстів українською
- Розпізнавання типу події (новий/оновлений)

---

## 🔔 API для Push-повідомлень

### 1. Нові графіки
**Використання:** "📅 Доступний графік за 19 листопада"

```bash
GET /api/updates/new?hours=24
```

**Відповідь:**
```json
{
  "success": true,
  "count": 1,
  "schedules": [
    {
      "date": "2025-11-19",
      "publishedAt": "2025-11-18T20:15:30.000Z",
      "messageDate": "2025-11-18T20:14:52+02:00",
      "sourcePostId": 2472,
      "pushMessage": "📅 Доступний графік за 19 листопада"
    }
  ]
}
```

**Коли показувати:**
- Щойно опублікований графік на завтра
- Зазвичай публікується ввечері (18:00-22:00)

---

### 2. Оновлені графіки
**Використання:** "⚠️ Увага! Внесено зміни за 16 листопада о 22:10"

```bash
GET /api/updates/changed?hours=2
```

**Відповідь:**
```json
{
  "success": true,
  "count": 1,
  "schedules": [
    {
      "date": "2025-11-16",
      "updatedAt": "2025-11-16T22:10:45.000Z",
      "messageDate": "2025-11-16T22:09:31+02:00",
      "sourcePostId": 2467,
      "updateCount": 3,
      "pushMessage": "⚠️ Увага! Внесено зміни за 16 листопада о 22:10"
    }
  ]
}
```

**Коли показувати:**
- Коли графік оновлюється (нова версія)
- ОНОВЛЕНО в заголовку Telegram
- Критично важливо для користувачів!

---

### 3. Останні оновлення
**Використання:** Список останніх змін для користувача

```bash
GET /api/updates/recent?limit=5
```

**Відповідь:**
```json
{
  "success": true,
  "updates": [
    {
      "date": "2025-11-19",
      "lastUpdated": "2025-11-18T20:15:30.000Z",
      "changeType": "new",
      "updateCount": 1,
      "sourcePostId": 2472,
      "messageDate": "2025-11-18T20:14:52+02:00"
    },
    {
      "date": "2025-11-16",
      "lastUpdated": "2025-11-16T22:10:45.000Z",
      "changeType": "updated",
      "updateCount": 3,
      "sourcePostId": 2467,
      "messageDate": "2025-11-16T22:09:31+02:00"
    }
  ]
}
```

---

## 📝 Метадані та Історія

### Метадані для конкретної дати

```bash
GET /api/schedule/2025-11-16/metadata
```

**Відповідь:**
```json
{
  "success": true,
  "metadata": {
    "date": "2025-11-16",
    "lastUpdated": "2025-11-16T22:10:45.000Z",
    "firstPublished": "2025-11-15T20:00:00.000Z",
    "updateCount": 3,
    "changeType": "updated",
    "sourcePostId": 2467,
    "messageDate": "2025-11-16T22:09:31+02:00"
  }
}
```

**Як використовувати:**
- Показати користувачу: "Останнє оновлення: 16 листопада о 22:10"
- Відобразити кількість змін: "Графік оновлювався 3 рази"
- Badge "ОНОВЛЕНО" якщо updateCount > 1

---

### Повна історія змін

```bash
GET /api/schedule/2025-11-16/history
```

**Відповідь:**
```json
{
  "success": true,
  "date": "2025-11-16",
  "history": [
    {
      "changeType": "updated",
      "sourcePostId": 2467,
      "messageDate": "2025-11-16T22:09:31+02:00",
      "detectedAt": "2025-11-16T22:10:45.000Z",
      "data": {
        "date": "2025-11-16",
        "queues": [...],
        "source_msg_id": 2467
      }
    },
    {
      "changeType": "updated",
      "sourcePostId": 2465,
      "messageDate": "2025-11-16T18:30:00+02:00",
      "detectedAt": "2025-11-16T18:32:00.000Z",
      "data": {...}
    },
    {
      "changeType": "new",
      "sourcePostId": 2462,
      "messageDate": "2025-11-15T20:00:00+02:00",
      "detectedAt": "2025-11-15T20:01:00.000Z",
      "data": {...}
    }
  ]
}
```

**Як використовувати:**
- Показати timeline змін
- Порівняти версії графіків
- Відобразити користувачу що саме змінилося

---

## 🔄 Логіка Push-повідомлень

### Приклад інтеграції (псевдокод)

```javascript
// 1. Періодична перевірка нових графіків (кожні 10 хвилин)
setInterval(async () => {
  const newSchedules = await fetch('/api/updates/new?hours=1');

  for (const schedule of newSchedules.schedules) {
    // Відправити push
    sendPush({
      title: "Новий графік!",
      body: schedule.pushMessage,
      data: { date: schedule.date, type: "new" }
    });
  }
}, 10 * 60 * 1000);

// 2. Перевірка оновлень (частіше - кожні 5 хвилин)
setInterval(async () => {
  const updated = await fetch('/api/updates/changed?hours=1');

  for (const schedule of updated.schedules) {
    // ПРІОРИТЕТНЕ повідомлення
    sendPush({
      title: "⚠️ ЗМІНИ В ГРАФІКУ",
      body: schedule.pushMessage,
      data: { date: schedule.date, type: "updated" },
      priority: "high",
      sound: "alert.mp3"
    });
  }
}, 5 * 60 * 1000);
```

---

## 📱 Приклади UI

### 1. Список графіків з метаданими

```
┌─────────────────────────────────────┐
│ 📅 19 листопада                     │
│ Опубліковано: 18.11 о 20:14         │
│ [Графік відключень →]               │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 📅 16 листопада         🔄 ОНОВЛЕНО │
│ Останнє оновлення: 16.11 о 22:10    │
│ Змінювався 3 рази                   │
│ [Переглянути історію]               │
│ [Графік відключень →]               │
└─────────────────────────────────────┘
```

### 2. Детальна інформація про оновлення

```
📋 Графік на 16 листопада

⏱ Історія змін:
  • 22:10 - ОНОВЛЕНО (Post 2467)
  • 18:32 - Оновлення (Post 2465)
  • 20:01 - Опубліковано (Post 2462)

[Переглянути зміни]
```

---

## 🎯 Рекомендації

### Коли відправляти push:

1. **Нові графіки** (priority: normal)
   - Графік на завтра з'явився
   - Відправити ввечері (19:00-22:00)

2. **Оновлення графіків** (priority: high)
   - НЕГАЙНО коли з'являється оновлення
   - Особливо важливо для поточної дати
   - Звук + вібрація

3. **Нагадування** (priority: low)
   - Вранці: "Сьогодні будуть відключення"
   - За годину до відключення

### Як визначити важливість:

```javascript
function getPushPriority(schedule) {
  const today = new Date().toISOString().split('T')[0];
  const tomorrow = new Date(Date.now() + 86400000).toISOString().split('T')[0];

  if (schedule.changeType === 'updated') {
    if (schedule.date === today) return 'critical'; // Сьогодні!
    if (schedule.date === tomorrow) return 'high';
    return 'normal';
  }

  if (schedule.changeType === 'new') {
    if (schedule.date === tomorrow) return 'normal';
    return 'low';
  }
}
```

---

## 🗄️ База даних

### Таблиці:

1. **outages** - поточні графіки
2. **schedule_history** - історія всіх змін
3. **schedule_metadata** - метадані (час публікації, оновлення)

### Поля метаданих:

- `first_published_at` - коли вперше опубліковано
- `last_updated_at` - останнє оновлення
- `update_count` - кількість оновлень
- `change_type` - "new" або "updated"
- `message_date` - час повідомлення в Telegram

---

## ✅ Готово!

Тепер ви маєте повну систему для:
- Відстеження історії змін
- Відправки push-повідомлень
- Показу метаданих користувачам
- Визначення типу та важливості подій
